<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Progress Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50">
  <script src="./progress_tracker.js"></script>

  <div class="max-w-5xl mx-auto px-4 py-10">
    <div class="flex items-center justify-between gap-3 mb-5">
      <h1 class="text-2xl font-bold text-slate-900">Progress Report</h1>
      <div class="flex gap-2">
        <button id="printBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white font-semibold hover:bg-black">
          Print
        </button>
        <button id="downloadBtn" class="px-4 py-2 rounded-lg bg-slate-700 text-white font-semibold hover:bg-slate-800">
          Download Report
        </button>
        <button id="resetBtn" class="px-4 py-2 rounded-lg border border-slate-300 font-semibold text-slate-700 hover:bg-slate-100">
          Reset Data
        </button>
      </div>
    </div>

    <div id="content" class="space-y-6"></div>
  </div>

  <script>
    // If user tries direct access without form â†’ alert + redirect
    if (!window.VLProgress) {
      alert("Progress tracking script missing.");
    } else {
      VLProgress.initPage();
      VLProgress.markReportViewed();

      if (!VLProgress.hasUser()) {
        alert("To view the progress report, you must first fill in all your details in the user form.");
        // redirect top if opened inside iframe
        const target = "user_input.html?return=progressreport.html";
        try {
          if (window.top) window.top.location.href = target;
          else window.location.href = target;
        } catch {
          window.location.href = target;
        }
      } else {
        renderReport();
      }
    }

    function renderReport() {
      const state = VLProgress.getState();
      const user = state.user;

      const start = state.timestamps.sessionStart;
      const end = state.timestamps.reportViewedAt || new Date().toISOString();

      const simulationReport = getSimulationReportData();
      const pretestData = getAssessmentData("pretest");
      const posttestData = getAssessmentData("posttest");
      const formattedStart = formatTimestamp(start);
      const formattedEnd = formatTimestamp(end);
      const startDisplay = formattedStart || start || "-";
      const endDisplay = formattedEnd || end || "-";

      // total duration (sessionStart -> reportViewedAt)
      const totalMs = start ? (new Date(end).getTime() - new Date(start).getTime()) : 0;

      const baseSections = `
        <div class="bg-white rounded-2xl shadow border border-slate-200 p-6">
          <h2 class="text-xl font-bold text-slate-900 mb-3">User Details</h2>
          <div class="grid sm:grid-cols-2 gap-4 text-slate-700">
            <div><span class="font-semibold">Name:</span> ${escapeHTML(user.name)}</div>
            <div><span class="font-semibold">Email:</span> ${escapeHTML(user.email)}</div>
            <div><span class="font-semibold">Designation:</span> ${escapeHTML(user.designation)}</div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow border border-slate-200 p-6">
          <h2 class="text-xl font-bold text-slate-900 mb-3">Start / End & Duration</h2>
          <div class="space-y-3 text-slate-700">
            <div><span class="font-semibold">Session Start:</span> ${startDisplay}</div>
            <div><span class="font-semibold">Report Viewed (End):</span> ${endDisplay}</div>
            <div><span class="font-semibold">Total Duration:</span> ${VLProgress.formatMs(totalMs)}</div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow border border-slate-200 p-6">
          <h2 class="text-xl font-bold text-slate-900 mb-3">Assessment Scores</h2>
          <div class="overflow-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="text-slate-600 text-sm">
                  <th class="py-2 pr-4">Assessment</th>
                  <th class="py-2 pr-4">Score</th>
                  <th class="py-2">Last Updated</th>
                </tr>
              </thead>
              <tbody>
                ${generateAssessmentRow("Pre-test", pretestData)}
                ${generateAssessmentRow("Post-test", posttestData)}
              </tbody>
            </table>
          </div>
        </div>
      `;

      const simulationCard = `
        <div class="bg-white rounded-2xl shadow border border-slate-200 p-6">
          <h2 class="text-xl font-bold text-slate-900 mb-3">Simulation Report</h2>
          <p id="simulationReportStatus" class="text-sm text-slate-500 mb-2">
            Simulation report attached below.
          </p>
          <div class="mt-4 border border-slate-200 rounded-2xl overflow-hidden">
            <iframe
              id="simulationReportFrame"
              class="w-full hidden"
              loading="lazy"
              style="min-height: 540px; border: none;"
            ></iframe>
          </div>
        </div>
      `;

      const reportHTML = `${baseSections}${simulationCard}`;

      document.getElementById("content").innerHTML = reportHTML;

      renderSimulationReport(simulationReport);
    }

    function formatTimestamp(value) {
      if (!value) return null;
      const candidate = Number(value);
      const date = Number.isFinite(candidate) && String(value).trim().length
        ? new Date(candidate)
        : new Date(value);
      if (Number.isNaN(date.getTime())) return null;
      return date.toLocaleString();
    }

    function getSimulationReportData() {
      if (typeof localStorage === "undefined") return null;
      try {
        const keys = [];
        const activeHash = localStorage.getItem("vlab_exp2_active_user_hash");
        if (activeHash) {
          keys.push(`vlab_exp2_user_${activeHash}_simulation_report_html`);
        }
        keys.push("vlab_exp2_simulation_report_html");

        for (const key of keys) {
          const html = localStorage.getItem(key);
          if (html && html.trim()) {
            const updatedAt = localStorage.getItem(key.replace("_html", "_updated_at"));
            return { html, updatedAt };
          }
        }
      } catch (err) {
        // localStorage may be locked; ignore silently
        console.warn("Unable to read simulation report from storage", err);
      }
      return null;
    }

    function getAssessmentData(type) {
      if (typeof localStorage === "undefined") return null;
      try {
        const readValue = (key) => {
          try {
            const value = localStorage.getItem(key);
            return (value || "").toString().trim() ? value.trim() : null;
          } catch {
            return null;
          }
        };

        const activeHash = localStorage.getItem("vlab_exp2_active_user_hash");
        const candidates = [];

        if (activeHash) {
          candidates.push({
            score: `vlab_exp2_user_${activeHash}_${type}_score`,
            total: `vlab_exp2_user_${activeHash}_${type}_total`,
            updated: `vlab_exp2_user_${activeHash}_${type}_updated_at`
          });
        }

        candidates.push({
          score: `vlab_exp2_${type}_score`,
          total: `vlab_exp2_${type}_total`,
          updated: `vlab_exp2_${type}_updated_at`
        });

        for (const item of candidates) {
          const score = readValue(item.score);
          const total = readValue(item.total);
          const updatedAt = readValue(item.updated);
          if (score || total || updatedAt) {
            return { score, total, updatedAt };
          }
        }
      } catch (err) {
        console.warn("Unable to read assessment data from storage", err);
      }
      return null;
    }

    function renderSimulationReport(report) {
      const iframe = document.getElementById("simulationReportFrame");
      const status = document.getElementById("simulationReportStatus");

      if (!iframe || !status) return;

      if (!report || !report.html) {
        iframe.classList.add("hidden");
        status.textContent = "Run the simulation and click the Report button to attach it here.";
        return;
      }

      status.textContent = "Simulation report attached below.";

      try {
        iframe.srcdoc = report.html;
        iframe.classList.remove("hidden");
      } catch (err) {
        console.error("Failed to render simulation report iframe", err);
        iframe.classList.add("hidden");
        status.textContent =
          "The simulation report is saved, but the preview could not render. Please open it in a new tab after generating the report.";
      }
    }

    function generateAssessmentRow(title, data) {
      const score = data && (data.score || data.total);
      const scoreDisplay = score ? `${data.score || "0"} / ${data.total || "0"}` : "Not recorded";
      const updatedDisplay = data && data.updatedAt
        ? (formatTimestamp(data.updatedAt) || data.updatedAt)
        : "Not available";

      return `
        <tr class="border-t">
          <td class="py-2 pr-4 font-semibold text-slate-700">${title}</td>
          <td class="py-2 pr-4 text-slate-700">${escapeHTML(scoreDisplay)}</td>
          <td class="py-2 text-slate-500 text-sm">${escapeHTML(updatedDisplay)}</td>
        </tr>
      `;
    }

    function escapeHTML(s) {
      return String(s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    document.getElementById("printBtn").addEventListener("click", () => window.print());
    document.getElementById("downloadBtn").addEventListener("click", downloadReport);
    document.getElementById("resetBtn").addEventListener("click", () => {
      if (confirm("Reset all saved user data and timings?")) {
        VLProgress.resetAll();
        alert("Reset done. Redirecting to User Input form.");
        window.location.href = "user_input.html?return=aim.html";
      }
    });

    function downloadReport() {
      try {
        const blob = new Blob([document.documentElement.outerHTML], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement("a");
        anchor.href = url;
        anchor.download = "progress-report.html";
        anchor.click();
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      } catch (err) {
        console.error("Download failed", err);
        alert("Unable to download the report. Please use the Print button or save the page manually.");
      }
    }
  </script>
</body>
</html>
